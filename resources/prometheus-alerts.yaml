apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: monitoring-8
data:
  alerts.yml: |
    groups:
      - name: required-alerts
        # Intervalo de evaluación del grupo
        interval: 30s
        rules:

          # 1) HighCPUUsage — warning — CPU > 80% por 5 minutos
          - alert: HighCPUUsage
            expr: rate(container_cpu_usage_seconds_total{namespace="la-huella-8", container!="", container!="POD"}[5m]) > 0.8
            for: 5m
            labels:
              severity: warning
              category: resources
            annotations:
              summary: "CPU alta en {{ $labels.pod }}"
              description: "El pod {{ $labels.pod }} está usando >80% de CPU durante al menos 5 minutos en el namespace la-huella-8."

          # 2) HighMemoryUsage — warning — Memoria > 85% del límite por 5 minutos
          # Nota: se filtran contenedores con límite > 0 para evitar dividir por cero.
          - alert: HighMemoryUsage
            expr: (
                    container_memory_working_set_bytes{namespace="la-huella-8", container!="", container!="POD"}
                    /
                    on(namespace,pod,container)
                    container_spec_memory_limit_bytes{namespace="la-huella-8", container!="", container!="POD"}
                  ) > 0.85
                  and on(namespace,pod,container)
                  container_spec_memory_limit_bytes{namespace="la-huella-8", container!="", container!="POD"} > 0
            for: 5m
            labels:
              severity: warning
              category: resources
            annotations:
              summary: "Memoria alta en {{ $labels.pod }}"
              description: "El pod {{ $labels.pod }} está usando >85% del límite de memoria durante al menos 5 minutos en el namespace la-huella-8."

          # 3) PodNotReady — critical — Pod no está Running por 5 minutos
          - alert: PodNotReady
            expr: kube_pod_status_phase{namespace="la-huella-8", phase!~"Running|Succeeded"} > 0
            for: 5m
            labels:
              severity: critical
              category: availability
            annotations:
              summary: "Pod no está Ready: {{ $labels.pod }}"
              description: "El pod {{ $labels.pod }} está en estado {{ $labels.phase }} por al menos 5 minutos en el namespace la-huella-8."

          # 4) CertificateExpiringSoon — warning — Certificado expira en < 30 días (duración 1h)
          - alert: CertificateExpiringSoon
            expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 30
            for: 1h
            labels:
              severity: warning
              category: certificates
            annotations:
              summary: "Certificado por expirar: {{ $labels.name }}"
              description: "El certificado {{ $labels.name }} expira en menos de 30 días."

          # 5) BackupJobFailed — critical — Job de backup falló (duración 1m)
          - alert: BackupJobFailed
            expr: kube_job_status_failed{namespace="la-huella-8", job_name=~"postgres-backup.*"} > 0
            for: 1m
            labels:
              severity: critical
              category: backups
            annotations:
              summary: "Backup de PostgreSQL falló"
              description: "El job de backup {{ $labels.job_name }} ha fallado en el namespace la-huella-8."